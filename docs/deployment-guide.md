# Deployment Guide

## Prerequisites

- Azure subscription with Owner or Contributor role
- Azure CLI installed (`az --version`)
- Bicep CLI (`az bicep install`)
- Python 3.11+
- Azure Functions Core Tools (`func --version`) — only if deploying Function App code via CLI
- Owner or Contributor role on the target Azure subscription

---

## Step 1 — Collect Values You'll Need

Before deploying, gather these values:

```bash
# Your Entra ID object ID (needed for Key Vault access)
az ad signed-in-user show --query id -o tsv

# Your home tenant ID
az account show --query tenantId -o tsv

# Your Azure subscription ID
az account show --query id -o tsv
```

Also have ready:
- **Demo tenant GUID(s)** — the tenant ID of each GCC tenant you'll collect from
- **Entra ID group object IDs** for Grafana RBAC (optional — can be added post-deploy)

---

## Step 2 — Fill in Parameter File

Edit `infra/parameters/dev.bicepparam` before deploying:

```
param allowedTenantIds    = '<comma-separated-tenant-guids>'
param deployerObjectId    = '<your-entra-id-object-id>'
param grafanaAdminGroupId = '<group-guid>'   # optional
```

---

## Step 3 — Deploy Infrastructure

### Option A: Deploy to Azure Button (One-Click)

Click the **Deploy to Azure** button in the README. The Azure Portal opens a custom deployment blade — fill in the parameters and click **Review + Create**.

### Option B: Azure CLI / Bicep

```bash
# 1. Login
az login

# 2. Create resource group
az group create --name rg-purview-governance --location eastus

# 3. Deploy
az deployment group create \
  --resource-group rg-purview-governance \
  --template-file infra/main.bicep \
  --parameters infra/parameters/dev.bicepparam \
  --parameters deployerObjectId=$(az ad signed-in-user show --query id -o tsv)

# 4. Capture outputs — you will need these in later steps
az deployment group show \
  --resource-group rg-purview-governance \
  --name main \
  --query properties.outputs
```

**What the deployment creates automatically:**
- Storage Account (3 tables: AgencyPostureSnapshot, LabelNormalizationMap, AssessmentSummary)
- Key Vault — including a self-signed collector certificate (`collector-cert`, RSA-2048, 12-month validity)
- Azure OpenAI (GPT-4o deployment)
- Function App (Python 3.11, Consumption, Linux) with Managed Identity
- Azure Managed Grafana
- Log Analytics + Application Insights
- All RBAC role assignments (Managed Identity → Storage, Key Vault, OpenAI)

The certificate is generated by Key Vault during deployment. You do not need to run `openssl` or manage any local cert files.

---

## Step 4 — Register the Multi-Tenant Entra ID App

1. Go to **Entra ID → App registrations → New registration**
   - Name: `Purview Governance Collector`
   - Supported account types: **Accounts in any organizational directory (multi-tenant)**
   - Click **Register**

2. Note the **Application (client) ID** — this is your `CLIENT_ID`

3. **Upload the collector certificate** (generated by Key Vault in Step 3):

   ```bash
   # Download the public cert from Key Vault
   az keyvault certificate download \
     --vault-name <KEY_VAULT_NAME> \
     --name collector-cert \
     --file collector-public.cer \
     --encoding DER
   ```

   Then in the portal: **Certificates & secrets → Certificates → Upload certificate** → upload `collector-public.cer`

4. **API permissions → Add a permission → Microsoft Graph → Application permissions** — add all four:
   - `InformationProtectionPolicy.Read.All`
   - `SecurityEvents.Read.All`
   - `Reports.Read.All`
   - `ComplianceManager.Read.All`

5. Click **Grant admin consent** for your home tenant

---

## Step 5 — Deploy Function App Code

### Option 1: GitHub Actions (recommended)

Set the following in **GitHub → Settings → Secrets and variables → Actions**:

| Type | Name | Value |
|------|------|-------|
| Variable | `FUNCTION_APP_NAME` | From deployment outputs |
| Secret | `AZURE_FUNCTIONAPP_PUBLISH_PROFILE` | Download from Azure Portal → Function App → Get publish profile |

Then trigger the workflow: **Actions → Deploy Function App → Run workflow**

The workflow fires automatically on future pushes to `main` that touch `functions/**`.

### Option 2: Azure Functions Core Tools

```bash
cd functions
pip install -r requirements.txt --target .python_packages/lib/site-packages
func azure functionapp publish <FUNCTION_APP_NAME> --python
```

---

## Step 6 — Configure the Collector

Copy and fill in your `.env` file:

```bash
cp .env.example .env
```

Values from deployment outputs:

```ini
CLIENT_ID=<app-registration-client-id>

# Key Vault certificate (auto-generated during deploy — no cert files needed)
KEY_VAULT_URL=<keyVaultUri from outputs>
CERTIFICATE_NAME=collector-cert

FUNCTION_APP_URL=<functionAppUrl from outputs>/ingest
FUNCTION_APP_KEY=<get via: az functionapp keys list --resource-group rg-purview-governance --name <FUNCTION_APP_NAME> --query functionKeys>
```

---

## Step 7 — Onboard Customer Tenants

For each GCC tenant you want to collect from:

```bash
# Generate admin consent URL
python onboarding/consent_url_generator.py \
  --client-id <CLIENT_ID> \
  --tenant-id <CUSTOMER_TENANT_ID>
```

Send the URL to the customer's Global Admin. See [onboarding-guide.md](onboarding-guide.md) for the full email template and verification steps.

Once consent is approved, add the tenant to the Function App allow-list:

```bash
az functionapp config appsettings set \
  --resource-group rg-purview-governance \
  --name <FUNCTION_APP_NAME> \
  --settings ALLOWED_TENANT_IDS="<tenant-guid-1>,<tenant-guid-2>"
```

---

## Step 8 — Run the Collector

```bash
pip install -e .
purview-collect --tenant-id <CUSTOMER_TENANT_ID> --agency-id <AGENCY_NAME>
```

Add `--dry-run` to validate auth and payload without submitting.

---

## Step 9 — Configure Grafana

1. Open Azure Managed Grafana from the Azure Portal
2. Install the **Infinity** datasource plugin (Plugins → search "Infinity" → Install)
3. Add datasource:
   - Type: Infinity
   - Auth: Azure AD
   - Azure Cloud: Azure Public
   - Storage Account: from deployment outputs
4. Import dashboard: **Dashboards → Import → Upload JSON** → `grafana/dashboards/purview-governance.json`
5. Assign Entra ID groups to Grafana Admin/Editor/Viewer roles

---

## Post-Deployment Options

### Enable mTLS on Function App (optional, production hardening)

```bash
az webapp config set \
  --resource-group rg-purview-governance \
  --name <FUNCTION_APP_NAME> \
  --client-cert-enabled true \
  --client-cert-mode Required
```

### Regenerate ARM Template (if Bicep files are modified)

```bash
az bicep build --file infra/main.bicep --outfile infra/azuredeploy.json
```

---

## Deployment Checklist

- [ ] Parameter file filled in (`infra/parameters/dev.bicepparam`)
- [ ] Resource group created
- [ ] Bicep deployment completed — outputs captured
- [ ] Multi-tenant app registered in home Entra ID
- [ ] Public cert downloaded from Key Vault and uploaded to app registration
- [ ] API permissions added and admin consent granted
- [ ] Function App code deployed (GitHub Actions or Core Tools)
- [ ] `FUNCTION_APP_NAME` and publish profile set in GitHub repo settings
- [ ] `.env` configured with Key Vault URL, cert name, client ID, function URL and key
- [ ] Customer tenant(s) consented via admin consent URL
- [ ] Tenant IDs added to Function App allow-list
- [ ] First collection run successful (`purview-collect --dry-run`)
- [ ] Grafana Infinity plugin installed and datasource configured
- [ ] Dashboard imported and showing data
- [ ] Entra ID groups assigned Grafana RBAC roles
